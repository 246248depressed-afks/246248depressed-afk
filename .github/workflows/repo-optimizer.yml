name: ğŸ”¥ Genesis Forge Pro â€“ Full Access AI Engineer

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      target_repo:
        description: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      ai_prompt:
        description: 'Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ù…Ù†ØµØªÙƒ'
        required: true
        type: string
      improvement_scope:
        description: 'Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'
        required: true
        type: choice
        options: [partial, full, refactor, security, performance, all]
        default: all
      base_branch:
        description: 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ'
        required: true
        default: main

permissions:
  contents: write
  pull-requests: write

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  TARGET_TOKEN: ${{ secrets.TARGET_TOKEN }}

jobs:
  genesis-forge:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ğŸ” ÙØ­Øµ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
        shell: bash
        run: |
          set -euo pipefail
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ env.TARGET_TOKEN }}" \
            "https://api.github.com/repos/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}")
          if [ "$code" != "200" ]; then
            echo "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù. Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©: $code"
            exit 1
          fi
          echo "âœ… ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù…Ø¤ÙƒØ¯"

      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù (Full Access)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}
          token: ${{ env.TARGET_TOKEN }}
          path: target
          fetch-depth: 0
          ref: ${{ github.event.inputs.base_branch }}

      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‡ÙˆÙŠØ© Git
        shell: bash
        run: |
          set -euo pipefail
          cd target
          git config user.name "Genesis Forge AI"
          git config user.email "genesis-forge@ai.engineer"

      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        shell: bash
        run: |
          set -euo pipefail
          cd target
          echo "ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª: $(find . -type f | wc -l)"
          echo "ğŸ“ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª: $(find . -type d | wc -l)"
          echo "ğŸ’¾ Ø§Ù„Ø­Ø¬Ù…: $(du -sh . | cut -f1)"

      - name: ğŸ§  Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø¥Ù„Ù‰ DeepSeek (Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
        shell: bash
        run: |
          set -euo pipefail
          echo "Skipping DeepSeek call for this test run."

      - name: âœï¸ ØªØ·Ø¨ÙŠÙ‚ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
        shell: bash
        run: |
          set -euo pipefail
          cd target
          echo "Hello from Genesis Forge AI - $(date)" >> README.md
          echo "Test modification applied."

      - name: ğŸ’¾ Commit, Push, and Create PR
        shell: bash
        env:
          BASE_BRANCH: ${{ github.event.inputs.base_branch }}
          AI_PROMPT: ${{ github.event.inputs.ai_prompt }}
          OWNER: ${{ github.event.inputs.target_owner }}
          REPO: ${{ github.event.inputs.target_repo }}
        run: |
          set -euo pipefail
          cd target

          # ØªØ£ÙƒØ¯ Ù…Ù† ØªØªØ¨Ø¹ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
          git fetch origin "$BASE_BRANCH"
          git checkout -B "$BASE_BRANCH" "origin/$BASE_BRANCH"

          BRANCH_NAME="genesis-forge-ai-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          # Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          git add -A

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù€ commit
          if ! git diff --cached --quiet; then
            echo "ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§ØªØŒ Ø³ÙŠØªÙ… Ø¹Ù…Ù„ commit."
            git commit -m "ğŸ¤– AI Test Optimization via Genesis Forge"

            echo "Pushing changes to new branch: $BRANCH_NAME"
            git push origin "$BRANCH_NAME"

            echo "Creating Pull Request..."

            # ØªÙˆÙ„ÙŠØ¯ JSON Ø³Ù„ÙŠÙ… Ù„Ù„Ù€ PR Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ heredoc
            PR_TITLE="ğŸ¤– Genesis Forge AI Test (${{ github.run_id }})"
            PR_BODY="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± AI Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª:\n\n> ${AI_PROMPT}"

            JSON_PAYLOAD=$(printf '%s' \
              "$(jq -n --arg title "$PR_TITLE" \
                       --arg head "$BRANCH_NAME" \
                       --arg base "$BASE_BRANCH" \
                       --arg body "$PR_BODY" \
                       '{title: $title, head: $head, base: $base, body: $body}')" )

            curl -f -X POST \
              -H "Authorization: token ${{ env.TARGET_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -d "$JSON_PAYLOAD" \
              "https://api.github.com/repos/${OWNER}/${REPO}/pulls"

            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ Pull Request Ø¨Ù†Ø¬Ø§Ø­."
          else
            echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§."
          fi

      - name: âœ… Ø§Ù„Ø®Ù„Ø§ØµØ©
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ”¥ Genesis Forge AI Ø£Ù†Ù‡Ù‰ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­"

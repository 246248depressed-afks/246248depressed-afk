name: ðŸ”§ Ultimate Forge Pro - Genesis System

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      target_repo:
        description: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      target_token:
        description: 'GitHub Token Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù (Ù„Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©)'
        required: true
        type: string
      improvement_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨'
        required: true
        type: choice
        options:
          - code_quality
          - performance
          - error_handling
          - documentation
          - security
          - all
        default: 'code_quality'
      custom_command:
        description: 'Ø£Ù…Ø± Ù…Ø®ØµØµ Ù„Ù„ØªØ­Ø³ÙŠÙ†'
        required: false
        type: string

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  TARGET_TOKEN: ${{ github.event.inputs.target_token }}

jobs:
  check-and-analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      can_access: ${{ steps.check_access.outputs.can_access }}
      project_type: ${{ steps.detect_project.outputs.project_type }}
    
    steps:
      - name: ðŸ” ÙØ­Øµ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„
        id: check_access
        env:
          TARGET_TOKEN: ${{ github.event.inputs.target_token }}
        run: |
          echo "ðŸ” ÙØ­Øµ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TARGET_TOKEN" \
            "https://api.github.com/repos/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù"
            echo "can_access=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (HTTP: $RESPONSE)"
            echo "can_access=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“± ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        id: detect_project
        if: steps.check_access.outputs.can_access == 'true'
        env:
          TARGET_TOKEN: ${{ github.event.inputs.target_token }}
        run: |
          echo "ðŸ“± Ø¬Ø§Ø±ÙŠ ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹..."
          
          REPO_URL="https://x-access-token:$TARGET_TOKEN@github.com/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}.git"
          git clone --depth 1 "$REPO_URL" temp-repo
          cd temp-repo
          
          if [ -f "build.gradle" ] || [ -f "app/build.gradle" ]; then
            echo "ðŸŽ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Android"
            echo "project_type=android" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "ðŸŸ¢ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Node.js"
            echo "project_type=nodejs" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ]; then
            echo "â˜• Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Java"
            echo "project_type=java" >> $GITHUB_OUTPUT
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Python"
            echo "project_type=python" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: Ø¹Ø§Ù…"
            echo "project_type=general" >> $GITHUB_OUTPUT
          fi
          
          cd ..
          rm -rf temp-repo

  analyze-and-optimize:
    runs-on: ubuntu-latest
    needs: check-and-analyze
    if: needs.check-and-analyze.outputs.can_access == 'true'
    timeout-minutes: 30
    
    steps:
      - name: ðŸŽ¯ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø³ÙŠÙ†
        run: |
          echo "ðŸš€ Genesis Forge Pro - Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ø³ÙŠÙ†"
          echo "========================================"
          echo "ðŸ‘¨â€ðŸ’» Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³: ${{ github.repository }}"
          echo "ðŸŽ¯ Ø§Ù„Ù‡Ø¯Ù: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}"
          echo "ðŸ”§ Ø§Ù„Ù†ÙˆØ¹: ${{ github.event.inputs.improvement_type }}"
          echo "âš¡ Ø§Ù„Ø£Ù…Ø±: ${{ github.event.inputs.custom_command || 'Ø¨Ø¯ÙˆÙ† Ø£Ù…Ø± Ù…Ø®ØµØµ' }}"
          echo "ðŸ“± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${{ needs.check-and-analyze.outputs.project_type }}"
          echo ""

      - name: ðŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù
        env:
          TARGET_TOKEN: ${{ github.event.inputs.target_token }}
        run: |
          echo "ðŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù..."
          REPO_URL="https://x-access-token:$TARGET_TOKEN@github.com/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}.git"
          git clone "$REPO_URL" target-repo
          cd target-repo
          git config user.email "genesis-forge@ai.com"
          git config user.name "Genesis Forge AI"
          echo "âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­"
          echo "ðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:"
          echo "  - Ø§Ù„Ø­Ø¬Ù…: $(du -sh . | cut -f1)"
          echo "  - Ø§Ù„Ù…Ù„ÙØ§Øª: $(find . -type f | wc -l)"

      - name: ðŸ¤– Ø§Ø³ØªØ´Ø§Ø±Ø© Genesis Forge AI
        if: env.DEEPSEEK_API_KEY != ''
        run: |
          echo "ðŸ¤– Ø§Ø³ØªØ´Ø§Ø±Ø© Genesis Forge AI Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª..."
          cd target-repo
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ´Ø§Ø±Ø© AI Ø¨Ø³ÙŠØ·Ø©
          cat > ai_consultation.md << 'EOF'
# ðŸ§  Ø§Ø³ØªØ´Ø§Ø±Ø© AI Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª

## ðŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
- **Ø§Ù„Ù†ÙˆØ¹**: ${{ needs.check-and-analyze.outputs.project_type }}
- **Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†**: ${{ github.event.inputs.improvement_type }}
- **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date)

## ðŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ø§Ù…Ø©
1. ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ«ÙŠÙ‚
3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
EOF

      - name: ðŸ” ÙØ­Øµ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
        run: |
          echo "ðŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª..."
          cd target-repo
          
          # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„
          cat > analysis_report.md << 'EOF'
# ðŸ“Š ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

## ðŸŽ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
- **Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹**: ${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}
- **Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹**: ${{ needs.check-and-analyze.outputs.project_type }}
- **Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†**: ${{ github.event.inputs.improvement_type }}

## ðŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
- **Ø§Ù„Ù…Ù„ÙØ§Øª**: $(find . -type f | wc -l)
- **Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª**: $(find . -type d | wc -l)
- **Ø§Ù„Ø­Ø¬Ù…**: $(du -sh . | cut -f1)

## ðŸ” Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

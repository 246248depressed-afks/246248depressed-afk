name: ğŸ”¥ Genesis Forge Pro â€“ Full Access AI Engineer

on:
  workflow_dispatch:
    inputs:
      target_owner:
        description: 'Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      target_repo:
        description: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù'
        required: true
        type: string
      ai_prompt:
        description: 'Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ù…Ù†ØµØªÙƒ'
        required: true
        type: string
      improvement_scope:
        description: 'Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'
        required: true
        type: choice
        options: [partial, full, refactor, security, performance, all]
        default: all
      base_branch:
        description: 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ'
        required: true
        default: main

permissions:
  contents: write
  pull-requests: write

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  TARGET_TOKEN: ${{ secrets.TARGET_TOKEN }}

jobs:
  genesis-forge:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ğŸ” ÙØ­Øµ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TARGET_TOKEN" \
            https://api.github.com/repos/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }})

          if [ "$code" != "200" ]; then
            echo "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„"
            exit 1
          fi
          echo "âœ… ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù…Ø¤ÙƒØ¯"

      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù‡Ø¯Ù (Full Access)
        run: |
          git clone https://x-access-token:$TARGET_TOKEN@github.com/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}.git target
          cd target
          git config user.name "Genesis Forge AI"
          git config user.email "genesis-forge@ai.engineer"

      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        run: |
          cd target
          echo "ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª: $(find . -type f | wc -l)"
          echo "ğŸ“ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª: $(find . -type d | wc -l)"
          echo "ğŸ’¾ Ø§Ù„Ø­Ø¬Ù…: $(du -sh . | cut -f1)"

      - name: ğŸ§  Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø¥Ù„Ù‰ DeepSeek
        run: |
          cd target

          cat > deepseek_prompt.txt << 'EOF'
SYSTEM:
Ø£Ù†Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø®Ø§Ø±Ù‚.
Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.

SCOPE:
${{ github.event.inputs.improvement_scope }}

USER PROMPT:
${{ github.event.inputs.ai_prompt }}

RULES:
- Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙØ¹Ù„ÙŠØ§Ù‹
- Ø­Ø³Ù‘Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
- Ù„Ø§ ØªÙƒØ³Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
- Ø£Ù†Ø´Ø¦ commits ÙˆØ§Ø¶Ø­Ø©
EOF

          curl https://api.deepseek.com/v1/chat/completions \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -H "Content-Type: application/json" \
            -d @<(jq -n --arg p "$(cat deepseek_prompt.txt)" '{
              model:"deepseek-coder",
              messages:[{role:"user",content:$p}]
            }') > deepseek_response.json

      - name: ğŸ“œ Ø¹Ø±Ø¶ Ù…Ø®Ø±Ø¬Ø§Øª DeepSeek
        run: |
          jq '.choices[0].message.content' deepseek_response.json || echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ø¶Ø­Ø©"

      - name: âœï¸ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Placeholder Engine)
        run: |
          cd target
          echo "âš ï¸ Ù‡Ù†Ø§ ÙŠØªÙ… Ø±Ø¨Ø· Ù…Ø­Ø±ÙƒÙƒ Ø§Ù„Ø®Ø§Øµ Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø®Ø±Ø¬Ø§Øª DeepSeek"
          echo "Ù…Ø«Ø§Ù„: parser â†’ diff â†’ overwrite files"

      - name: ğŸ’¾ Commit Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        run: |
          cd target
          git checkout -b genesis-forge-ai || git checkout genesis-forge-ai
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ¤– AI Optimization via Genesis Forge"
          else
            echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§"
          fi

      - name: ğŸš€ Push Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        run: |
          cd target
          git push origin genesis-forge-ai

      - name: ğŸ”€ Ø¥Ù†Ø´Ø§Ø¡ Pull Request ØªÙ„Ù‚Ø§Ø¦ÙŠ
        run: |
          curl -X POST \
            -H "Authorization: token $TARGET_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.event.inputs.target_owner }}/${{ github.event.inputs.target_repo }}/pulls \
            -d "{
              \"title\": \"ğŸ¤– Genesis Forge AI Optimization\",
              \"head\": \"genesis-forge-ai\",
              \"base\": \"${{ github.event.inputs.base_branch }}\",
              \"body\": \"ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø´Ø§Ù…Ù„Ø© Ø¹Ø¨Ø± AI Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©.\"
            }"

      - name: âœ… Ø§Ù„Ø®Ù„Ø§ØµØ©
        run: |
          echo "ğŸ”¥ Genesis Forge AI Ø£Ù†Ù‡Ù‰ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­"
          echo "ğŸ” ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„"
          echo "ğŸ§  ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¨Ø± Ø¨Ø±ÙˆÙ…Ø¨Øª"
          echo "ğŸ“¦ Commit + PR Ø¬Ø§Ù‡Ø²ÙŠÙ†"
